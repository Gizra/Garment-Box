<?php
/**
 * @file
 * Code for the Opengizra BOM.
 */


/**
 * Implement hook_field_formatter_info().
 */
function opengizra_bom_field_formatter_info() {
  return array(
    'opengizra_bom_table' => array(
      'label' => t('BOM table'),
      'field types' => array('field_collection'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function opengizra_bom_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {

  $settings = $display['settings'];

  switch ($display['type']) {
    case 'opengizra_bom_table':
      $field_name = $field['field_name'];
      $dummy_display = $display;
      $dummy_display['type'] = 'field_collection_table_view';
      $element = field_view_field($entity_type, $entity, $field_name, $dummy_display);

      // Inject header.
      $last_col = array_pop($element[0]['#header']);

      $total = 0;

      foreach ($element[0]['#header'] as $key => $value) {
        if ($value['class'] == 'field_material') {
          $material_delta = $key;
          break;
        }
      }


      $element[0]['#header'][] = array(
        'data' => t('Price'),
        'class' => 'field_price',
      );

      $element[0]['#header'][] = $last_col;

      $wrapper = entity_metadata_wrapper($entity_type, $entity);

      // Inject rows.
      foreach ($element[0]['#rows'] as $key => $row) {
        $last_col = array_pop($row['data']);

        $material_wrapper = entity_metadata_wrapper('field_collection_item', $row['data'][$material_delta]['data']['#object']->item_id);
        $collection_item = $material_wrapper->field_material->field_source_info->value();
        $field_price = field_view_field('field_collection_item', $collection_item, 'field_price', array('label' => 'hidden', 'type' => 'commerce_price_formatted_amount'));

        $row['data'][] = array(
          'data' => $field_price,
          'class' => 'field_price',
        );
        $row['data'][] = $last_col;
        $element[0]['#rows'][$key] = $row;

        // Calculate the total.
        $collection_wrapper = $material_wrapper->field_material->field_source_info;
        $unit_price = $collection_wrapper->field_price->amount->value();

        $material_unit = $material_wrapper->field_material->field_source_info->field_unit->value();
        $material_length_unit = $material_wrapper->field_material->field_source_info->field_length_unit->value();
        $material_length = $material_wrapper->field_material->field_source_info->field_length->value();

        $bom_unit = $collection_wrapper->field_unit->value();
        $bom_quantity = $wrapper->field_bom_info->get($key)->field_quantity->value();
        if ($material_unit == $bom_unit) {
          $total += $bom_quantity * $unit_price;
        }
        elseif ($material_length_unit) {
          // Use the conversion given in the material.
          $total += $bom_quantity / $material_length * $unit_price;
        }
      }

      // Re-create the element, and add the total.
      $table = $element[0];
      $element[0] = array();

      $element[0]['table'] = $table;
      $element[0]['total']['#markup'] = t('Total: @total', array('@total' => commerce_currency_format($total, 'USD')));


      return $element;
  }
}
