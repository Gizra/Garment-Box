<?php
/**
 * @file
 * Code for the Garmentbox Factory feature.
 */

include_once 'garmentbox_factory.features.inc';

/**
 * Implements hook_ctools_plugin_directory().
 */
function garmentbox_factory_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements hook_field_access().
 *
 * Hide the order status when craeting a new production order.
 */
function garmentbox_factory_field_access($op, $field, $entity_type, $entity, $account) {
  if ($op != 'edit' || $field['field_name'] != 'field_order_status' || $entity->type != 'production_order') {
    return;
  }

  // Check if creating a new production order.
  if (empty($entity->nid)) {
    return FALSE;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function garmentbox_factory_form_production_order_node_form_alter(&$form, &$form_state) {
  // The field is disabled in garmentbox_inventory_field_access().
  $form['field_delivery_date']['#access'] = TRUE;

  if (empty($form['field_season'][LANGUAGE_NONE]['#default_value'][0])) {
    return;
  }
  $season_nid = $form['field_season'][LANGUAGE_NONE]['#default_value'][0];

  // Set a default factory.
  if (!$form['field_factory'][LANGUAGE_NONE]['#default_value']) {
    $form['field_factory'][LANGUAGE_NONE]['#options'];
    // Remove the "none" option.
    if (!empty($form['field_factory'][LANGUAGE_NONE]['#options']['_none'])) {
      unset($form['field_factory'][LANGUAGE_NONE]['#options']['_none']);
    }
    $form['field_factory'][LANGUAGE_NONE]['#default_value'] = key($form['field_factory'][LANGUAGE_NONE]['#options']);
  }
  $factory_nid = $form['field_factory'][LANGUAGE_NONE]['#default_value'];
  $item_variant_nids = garmentbox_factory_get_factory_item_variants($season_nid, $factory_nid);

  if (!$form['nid']['#value']) {
    $inventory_lines_nids = garmentbox_factory_get_production_order_inventory_lines($item_variant_nids);
  }
  else {
    $inventory_lines_nids = garmentbox_factory_get_production_order_inventory_lines($form['nid']['#value']);
  }

  $raw_data = garmentbox_factory_production_order_items_data($item_variant_nids, $inventory_lines_nids);
  // Dummy inputs, that will actually be added manually inside
  // inventory_lines_table as checkboxes.
  // Add an option to select no lines.
  $inventory_lines_nids[''] = '';
  $form['production_order_inventory_lines'] = array(
    '#type' => 'hidden',
    '#options' => drupal_map_assoc($inventory_lines_nids),
  );
  // Add dummy inputs for the "Add more items" size fields.
  $form['variant_new_inventory'] = array(
    '#type' => 'hidden',
  );
  $form_state['item_variants'] = $item_variant_nids;

  $variables = array(
    'rows' => garmentbox_factory_production_order_items($raw_data),
    'header' => array(
      t('Include in order'),
      t('Item variation'),
      t('Quantity / Size'),
      t('Fabric'),
      t('Production cost'),
      t('Add more items'),
    ),
    'attributes' => array('id' => 'inventory-lines-table'),
  );
  $form['inventory_lines_table'] = array(
    '#type' => 'markup',
    '#markup' => theme('table', $variables),
    '#weight' => 50,
  );

  $form['#attached']['js'] = array(
    drupal_get_path('module', 'garmentbox_factory') . '/production_order_items.js',
  );
  format_number_add_js();

  $options = array(
    'absolute' => TRUE,
    'query' => array(
      'field_season' => $_GET['field_season'],
    )
  );

  $settings = array(
    'url' => url($_GET['q'], $options),
    'inventory_lines_data' => $raw_data,
  );
  drupal_add_js(array('garmentbox_factory' => $settings), 'setting');

  // Validation for the custom quantity fields.
  $form['#validate'][] = 'garmentbox_factory_form_production_order_node_form_validate';

  $form['add_variant_button'] = array(
    '#type' => 'markup',
    '#markup' => l(t('Add a variant'), '', array('attributes' => array('id' => 'add-variant'))),
    '#weight' => 55,
  );
}

/**
 * Validate handler.
 *
 * Validate the new inventory forms manually.
 */
function garmentbox_factory_form_production_order_node_form_validate(&$form, &$form_state) {
  foreach ($form_state['values']['variant_new_inventory'] as $nid => $size_data) {
    foreach ($size_data as $tid => $quantity) {
      if (!$quantity) {
        continue;
      }

      // Make sure the quantity is a positive integer.
      if (!is_numeric($quantity) || (int)$quantity != $quantity || $quantity < 0) {
        // TODO: When this error is applied, it causes the following notice on
        // the next refresh on node/add/production-prder:
        // Notice: Array to string conversion in drupal_attributes() (line 2303 of [...]/www/includes/common.inc).
        form_set_error('', t('Quantity must be a positive integer.'));
      }
    }
  }
}

/**
 * @param $factory_nid
 *   Factory NID.
 * @param $season_nid
 *   Season NID.
 *
 * @return
 *   Array of item variants NIDs.
 */
function garmentbox_factory_get_factory_item_variants($season_nid, $factory_nid) {
  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'node')
    ->propertyCondition('type', 'item_variant')
    ->propertyCondition('status', NODE_PUBLISHED)
    ->fieldCondition('field_factory', 'target_id', $factory_nid)
    ->fieldCondition('field_reference_hierarchy', 'target_id', $season_nid)
    ->propertyOrderBy('title')
    ->execute();

  return !empty($result['node']) ? array_keys($result['node']) : array();
}

/**
 * @param $nids
 *   Item variants NIDs or a production order nid.
 *
 * @return
 *   Array of inventory lines NIDs.
 */
function garmentbox_factory_get_production_order_inventory_lines($nids) {
  $query = new EntityFieldQuery();
  $query
    ->entityCondition('entity_type', 'node')
    ->propertyCondition('type', 'inventory_line')
    ->propertyCondition('status', NODE_PUBLISHED);

  if (is_array($nids)) {
    if (!$nids) {
      return array();
    }
    $query->fieldCondition('field_item_variant', 'target_id', $nids, 'IN');
  }
  else {
    $query->fieldCondition('field_production_order', 'target_id', $nids);
  }

  $query->fieldOrderBy('field_item_variant', 'target_id');
  $result = $query->execute();

  return !empty($result['node']) ? array_keys($result['node']) : array();
}

/**
 * @param $raw_data
 *   A prodution order inventory lines data.
 *
 * @return
 *   The production order items table.
 */
function garmentbox_factory_production_order_items($raw_data) {
  $table = array();
  foreach ($raw_data as $variant_nid => $variant) {
    if (!$variant['lines']) {
      continue;
    }

    $row = array(
      'data' => array(),
      'id' => 'variant-' . $variant_nid,
      'class' => array('expandable'),
    );
    $row['data'][] = '<input type="checkbox" class="triple-checkbox" />';
    $row['data'][] = array(
      'data' => l($variant['title'], ''),
      'class' => array('item-title'),
    );
    $row['data'][] = _garmentbox_factory_production_order_items_format_sizes($variant['sizes']);
    $row['data'][] = garmentbox_item_get_main_material_icon($variant_nid);
    $row['data'][] = array(
      'data' => t('N/A'),
      'class' => array('item-price'),
    );
    $row['data'][] = array(
      'data' => l(t('Add more items'), ''),
      'class' => array('add-inventory-line'),
    );
    $table[] = $row;

    foreach ($variant['lines'] as $inventory_line_nid => $inventory_line) {
      $row = array(
        'data' => array(),
        'ref' => 'variant-' . $variant_nid,
        'class' => array('hidden', 'inventory-line'),
      );

      $checkbox = "<input
        type=\"checkbox\"
        name=\"production_order_inventory_lines[$inventory_line_nid]\"
        value=\"$inventory_line_nid\"
        checked=\"checked\"
      />";
      $row['data'][] = $checkbox;
      $customer = $inventory_line['customer'] ? $inventory_line['customer'] : t('N/A');
      $row['data'][] = t('<b>Customer</b> !customer', array('!customer' => $customer));
      $row['data'][] = _garmentbox_factory_production_order_items_format_sizes($inventory_line['sizes']);
      $row['data'][] = '';
      $row['data'][] = commerce_currency_format($variant['item_price'] * $inventory_line['items_count'], commerce_default_currency());
      $row['data'][] = '';
      $table[] = $row;
    }

    // Add an hidden "Add more items" row.
    $row = array(
      'data' => array(),
      'ref' => 'variant-' . $variant_nid,
      'class' => array('hidden', 'new-inventory-line'),
    );
    $row['data'][] = '';
    $row['data'][] = $variant['title'];
    $row['data'][] = _garmentbox_factory_production_order_items_format_sizes($variant_nid);
    $row['data'][] = '';
    $row['data'][] = t('N/A');
    $row['data'][] = '';
    $table[] = $row;
  }

  // "Add more items of another variation" row.
  $row = array(
    'data' => array(),
    'class' => array('hidden', 'new-inventory-line', 'other-variant'),
  );
  $row['data'][] = '';
  $row['data'][] = 'variants';
  $row['data'][] = '';;
  $row['data'][] = '';
  $row['data'][] = t('N/A');
  $row['data'][] = '';
  $table[] = $row;

  return $table;
}

/**
 *
 */
function garmentbox_factory_production_order_items_data($item_variants_nids, $inventory_lines_nids) {
  if (!$inventory_lines_nids) {
    return array();
  }

  $vocabulary = taxonomy_vocabulary_machine_name_load('size');
  $size_tree = taxonomy_get_tree($vocabulary->vid);

  $data = array();
  foreach ($item_variants_nids as $variant_nid) {
    $wrapper = entity_metadata_wrapper('node', $variant_nid);
    $data[$variant_nid] = array(
      'title' => $wrapper->label(),
      'lines' => array(),
      'item_price' => garmentbox_bom_get_variant_bom_price($variant_nid) + garmentbox_bol_get_variant_bol_price($variant_nid),
    );

    foreach ($size_tree as $term) {
      $data[$variant_nid]['sizes'][$term->tid] = 0;
    }
  }

  // Fetch inventory lines of a factory.
  foreach (node_load_multiple($inventory_lines_nids) as $inventory_line) {
    $wrapper = entity_metadata_wrapper('node', $inventory_line);

    $variant_nid = $wrapper->field_item_variant->getIdentifier();

    $data[$variant_nid]['lines'][$inventory_line->nid] = array(
      'sizes' => array(),
      'items_count' => 0,
      'customer' => '',
    );

    foreach ($wrapper->field_quantity_info as $quantity_wrapper) {
      $size_tid = $quantity_wrapper->field_size->getIdentifier();
      $quantity = $quantity_wrapper->field_quantity_integer->value();

      if (empty($data[$variant_nid]['lines'][$inventory_line->nid]['sizes'][$size_tid])) {
        $data[$variant_nid]['lines'][$inventory_line->nid]['sizes'][$size_tid] = 0;
      }

      $data[$variant_nid]['lines'][$inventory_line->nid]['sizes'][$size_tid] += $quantity;
      $data[$variant_nid]['lines'][$inventory_line->nid]['items_count'] += $quantity;
    }
  }

  // Cleanup empty item variants.
  foreach ($data as $nid => $variant) {
    if (empty($variant['lines'])) {
      unset($data[$nid]);
    }
  }

  // Fetch inventory lines of a factory.
  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'node')
    ->propertyCondition('type', 'order')
    ->propertyCondition('status', NODE_PUBLISHED)
    ->fieldCondition('field_inventory_line_inline', 'target_id', $inventory_lines_nids, 'IN')
    ->fieldOrderBy('field_inventory_line_inline', 'target_id')
    ->execute();

  if (empty($result['node'])) {
    return $data;
  }

  $orders = node_load_multiple(array_keys($result['node']));
  foreach ($orders as $order) {
    $wrapper = entity_metadata_wrapper('node', $order);
    $order_link = l($wrapper->field_customer->label(), 'node/' . $order->nid);

    foreach ($wrapper->field_inventory_line_inline as $inventory_line_wrapper) {
      $variant_nid = $inventory_line_wrapper->field_item_variant->getIdentifier();
      $inventory_line_nid = $inventory_line_wrapper->getIdentifier();
      // The order might have variants of different factories. Only consider
      // variants that were selected before.
      if (!empty($data[$variant_nid])) {
        $data[$variant_nid]['lines'][$inventory_line_nid]['customer'] = $order_link;
      }
    }
  }



  return $data;
}

/**
 * Format a "Sizes data" cell.
 *
 * @param $sizes
 *   Array of quantities per size TID, or an item variant NID.
 */
function _garmentbox_factory_production_order_items_format_sizes($sizes) {
  $vocabulary = taxonomy_vocabulary_machine_name_load('size');
  $size_tree = taxonomy_get_tree($vocabulary->vid);

  $nid = !is_array($sizes) ? $sizes : 0;

  $items = array();
  foreach ($size_tree as $term) {
    $id = $nid ? "size-$nid-$term->tid" : '';

    $item = "<label for=\"$id\">" . $term->name . '</label>';

    if (!$nid) {
      $quantity = !empty($sizes[$term->tid]) ? $sizes[$term->tid] : 0;
      $item .= "<span ref=\"tid-$term->tid\">" . $quantity . '</span>';
    }
    else {
      $item .= "<input
        name=\"variant_new_inventory[$nid][$term->tid]\"
        size=\"4\"
        id=\"$id\"
        class=\"new-inventory-items\"
      />";
    }

    $items[] = $item;
  }

  return theme('item_list', array('items' => $items, 'attributes' => array('class' => array('size-info'))));
}

/**
 * Implements hook_node_insert().
 *
 * When a production order is created, Set the production order reference on
 * the related inventory line nodes.
 */
function garmentbox_factory_node_insert($node) {
  if ($node->type != 'production_order') {
    return;
  }

  foreach ($node->production_order_inventory_lines as $nid) {
    $wrapper = entity_metadata_wrapper('node', $nid);
    $wrapper->field_production_order->set($node->nid);
    $wrapper->save();
  }

  // Handle creation of new inventory lines.
  foreach ($node->variant_new_inventory as $item_variant_nid => $quantity_info) {
    // Check if the variant's has any non-zero quantity.
    $create_inventory_line = FALSE;
    foreach ($quantity_info as $quantity) {
      if ($quantity) {
        $create_inventory_line = TRUE;
      }
    }

    if ($create_inventory_line) {
      garmentbox_factory_create_inventory_line($node->nid, $item_variant_nid, $quantity_info);
    }
  }
}

/**
 * Create a custom inventory line (Through the production order form).
 *
 * @param $production_order_nid
 *   Attach the inventory line to this production order.
 * @param $item_variant_nid
 *   The inventory line's item variant.
 * @param $quantity_info
 *   Array of quantities keyed by size TID. A new field_quantity_info item will
 *   be created for each entry.
 */
function garmentbox_factory_create_inventory_line($production_order_nid, $item_variant_nid, $quantity_info) {
  $node = new stdClass();
  $node->type = 'inventory_line';
  $node->language = LANGUAGE_NONE;
  node_object_prepare($node);

  $wrapper = entity_metadata_wrapper('node', $node);
  $wrapper->field_production_order->set($production_order_nid);
  $wrapper->field_item_variant->set($item_variant_nid);

  // Create field collection items for the quantity info items.
  foreach ($quantity_info as $tid => $quantity) {
    if (!$quantity) {
      continue;
    }

    $field_collection_item = entity_create('field_collection_item', array('field_name' => 'field_quantity_info'));
    $field_collection_item->setHostEntity('node', $node);
    $item_wrapper = entity_metadata_wrapper('field_collection_item', $field_collection_item);
    $item_wrapper->field_quantity_integer->set($quantity);
    $item_wrapper->field_size->set($tid);
    $item_wrapper->save();
  }

  $wrapper->save();
}

/**
 * Implements hook_node_update().
 *
 * When a production order is created, Set the production order reference on
 * the related inventory line nodes.
 */
function garmentbox_factory_node_update($node) {
  if ($node->type != 'production_order') {
    return;
  }

  // Remove references from removed inventory lines.
  $stored_inventory_lines = garmentbox_factory_get_production_order_inventory_lines($node->nid);
  foreach($stored_inventory_lines as $nid) {
    if (empty($node->production_order_inventory_lines[$nid])) {
      $wrapper = entity_metadata_wrapper('node', $nid);
      $wrapper->field_production_order->set(NULL);
      $wrapper->save();
    }
  }
}
